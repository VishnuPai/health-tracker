rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // --- Helper Functions ---

    function isAuthenticated() {
      return request.auth != null;
    }

    function isOwner(userId) {
      return request.auth.uid == userId;
    }

    // Fetch the requesting user's role from their profile document.
    function getUserRole() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role;
    }

    function isAdmin() {
      return isAuthenticated() && getUserRole() == 'admin';
    }

    function isCoachOrAdmin() {
      return isAuthenticated() && getUserRole() in ['coach', 'admin'];
    }

    // --- User Profile Documents ---
    match /users/{userId} {

      // Read own profile. Coaches and admins can read any profile (for user lists).
      allow read: if isAuthenticated()
                  && (isOwner(userId) || isCoachOrAdmin());

      // Users can only create their own profile, and role must default to 'user'.
      // This prevents a new user from self-assigning admin/coach on registration.
      allow create: if isAuthenticated()
                    && isOwner(userId)
                    && request.resource.data.role == 'user';

      // Owner can update own profile but CANNOT change the role field.
      // Admins can update any profile including role changes.
      allow update: if isAuthenticated()
                    && (
                      (isOwner(userId) && request.resource.data.role == resource.data.role)
                      || isAdmin()
                    );

      // Only admins can delete user profiles.
      allow delete: if isAdmin();

      // --- Health Data Subcollections (workouts, diet, sleep, labs, usage) ---
      match /{subcollection}/{docId} {
        // Owner can read/write own data.
        // Coaches and admins have read-only access to other users' data.
        allow read: if isAuthenticated()
                    && (isOwner(userId) || isCoachOrAdmin());
        allow write: if isAuthenticated()
                     && isOwner(userId);
      }
    }

    // Deny all access to any path not matched above.
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
